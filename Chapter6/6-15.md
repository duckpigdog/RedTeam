### Linux PAM 软链接后门

**1. 核心机制：服务名欺骗与 `pam_rootok`**

PAM 的工作机制是根据正在运行的**程序名**（`$PAM_SERVICE` 变量）去查找 `/etc/pam.d/` 目录下对应的配置文件

- **`pam_rootok.so` 模块**：这个模块的作用是检测当前用户的 **UID 是否为 0**（即 root）。如果用户是 root，它通常会返回 `PAM_SUCCESS`

- **短路机制 (`sufficient`)**：在 PAM 配置文件中，如果一个模块的控制标志设置为 `sufficient` (足够)，并且该模块返回 `PAM_SUCCESS`，那么 PAM 就会**立即停止后续的认证检查**，判定用户认证成功

- **利用点**：很多服务（尤其是 **`su`** 命令）的 PAM 配置文件中，都有以下或类似的短路规则：

  ```bash
  # 文件: /etc/pam.d/su (或 /etc/pam.d/chsh 等)
  auth sufficient pam_rootok.so
  # ... 接着是正常的密码验证模块，如 pam_unix.so ...
  ```

  这条规则的目的是：如果一个用户正在使用 `su` 切换到 `root` 账户，并且用户本身已经是 `root`（UID 0），那么就直接允许它通过，无需再次输入密码

**2. 攻击流程：**

攻击者利用这个短路机制，通过软链接进行欺骗：

1. **创建软链接**：攻击者在目标系统上以 **root 权限**创建一个指向 `/usr/sbin/sshd` 或 `/usr/bin/ssh` 的软链接，并将其命名为 `su`（或其他包含 `pam_rootok.so` 规则的服务名）

   ```bash
   # 在某个隐蔽目录创建
   ln -s /usr/sbin/sshd /tmp/.sys/su
   ```

2. **执行后门**：攻击者尝试通过这个**新的软链接路径**（例如 `/tmp/.sys/su`）来连接 SSH

3. **PAM 被欺骗**：SSH 客户端连接后，PAM 会被告知运行的服务名是 **`su`**，而不是 `sshd`

4. **绕过密码**：PAM 加载 `/etc/pam.d/su` 配置文件，发现第一条规则是 `auth sufficient pam_rootok.so`。由于 SSH 服务的连接用户在本地是 root（通常通过公钥认证或已知密码登录），或者攻击者在连接时声明自己是 root，`pam_rootok.so` 就会返回成功。`sufficient` 机制触发，认证链短路，**绕过了后续的密码验证**，允许攻击者无需密码或使用任何密码登录