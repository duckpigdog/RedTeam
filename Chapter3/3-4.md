### 白名单程序操作注册表 bypass UAC 提权

针对大型的攻防演练, 往往通过 Web 获取权限是非常艰难的。钓鱼变成了一个不错的获取权限的手段

我们通过 Web 打点获得权限往往是 service 权限, 而钓鱼获得的权限一般是用户权限, 而且针对钓鱼目标系统一 般是 Win7 或者 Win10,Win11 这样的个人 PC 非 Windows Server

在个人 PC 上, 初始的用户默认都是本地管理员组, 但是不是 administrator 用户, 虽然在管理员组但是权限依旧是受限的 ( 比如无法抓取 hash ) , 那我们可以通过 bypassUAC 进行提权

一个典型的白名单程序注册表劫持 bypass UAC 提权过程如下：

1. **寻找可利用的白名单程序：** 攻击者需要找到一个满足以下条件的白名单程序：
   - **高完整性级别：** 该程序默认以高权限运行
   - **非管理员权限可修改的注册表键值：** 该程序在启动时会读取 `HKCU` 下的特定注册表键值
   - **可执行外部程序：** 该注册表键值可以控制程序的行为，例如执行外部命令或加载外部程序
2. **修改注册表键值：** 攻击者在不触发 UAC 弹窗的情况下，可以修改 `HKCU` 下的注册表键值，将其值设置为恶意程序的路径
3. **启动白名单程序：** 攻击者通过命令行或其他方式，启动这个被利用的白名单程序
4. **提权成功：** 当白名单程序启动时，它会读取被修改的注册表键值，并以高权限执行恶意程序，从而实现了绕过 UAC 的权限提升

**什么是 UAC**

UAC（用户控制）是微软自 Win7 以及后续 Windows 系统中引入的一种访问控制功能（之后几乎所有的 Windows 版本都含有了 UAC）

 UAC 的主要目的是确保应用程序只限于标准用户用户权限，当需要其他权限时，回弹出提 示询问“是否允许以下程序对计算机进行更改？” 取个例子：一些软件的安装，都会弹出一个对话框，询问我们是否允许此程序对计算机进行更改

搜索 UAC

![](https://pic1.imgdb.cn/item/68d0daefc5157e1a88248b34.png)

![](https://pic1.imgdb.cn/item/68d0dc63c5157e1a88248cc2.png)

**当进行如下操作时需要经过 UAC 认证**

```
配置 Windows update
增加或者删除用户
改变用户类型
改变 UAC 设置
安装 ActiveX
安装或移除程序
安装设备驱动程序
设置家长控制
查看其他用户文件夹
更改注册表
更改系统保护或者高级系统设置
```

**UAC 触发流程**

```
触发 UAC 时，系统会创建一个 consent.exe 进程，该进程通过白名单和用户选择来判断是否创建管理员权限进
程
请求进程将要请求的进程 cmdline 和进程路径通过 LPC 接口传递给 appinfo 和 RAiLuanchAdminProcess
函数
该函数首先验证路径是否在白名单中，并将结果传递给 consent.exe 进程，该进程验证请求进程的签名
以及发起者的权限是否符合要求后，决定是否弹出 UAC 窗口让用户确认
这个 UAC 窗口会创建新的安全桌面，屏蔽之前的界面
同时这个 UAC 窗口进程时系统权限进程，其他普通进程无法和其进行通信交互
用户确认之后，会调用 CreateProcessAsUser 函数以管理员身份启动请求的进程
```

针对 bypassUAC 的两种方式, 目前主流的有两种，一种是基于白名单 bypassUAC， 一种是基于 com 接口 bypassUAC

**1. 白名单程序操作注册表 bypassUAC**

```
whoami /priv
```

![](https://pic1.imgdb.cn/item/68d0de5ec5157e1a882490ed.png)

白名单程序是指有一些系统程序是会直接获取管理员权限同时不弹出 UAC 弹窗，这类程序被称为白名单程序

这类程序会在启动时就静默提升权限，例如 `slui.exe、wusa.exe、 taskmgr.exe、 eudcedit.exe、eyentvwr.exe, CompMgmtLauncher,exe, rundll32.exe, explorer.exe` 等

**需要满足以下条件**

1. 程序的 manifest 标识的配置属性 autoElevate 为 true
2. 程序不弹出 UAC 弹窗
3. 从注册表里查询 `Shell\Open\command` 键值对（用来执行指定的应用）

关于 `Shell\open\command` 键值对，以它命名的键值对存储的是可执行文件的路径

如果 exe 程序运行的候找到该键值对，就会运行该键值对指向的程序，因为白名单中的 exe 运行的时候是默认提升了权 限，那么该键值对指向的程序就过了UAC，如果把恶意的exe 写入该键值对，那么当运行白名单中 exe 的时候，就能绕过UAC 执行恶意程序

ComputerDefaults.exe ( 设置中的默认应用 ) 就是满足条件的白名单

win + r , 输入 ComputerDefaults.exe 回车

![](https://pic1.imgdb.cn/item/68d0e052c5157e1a8824a618.png)

[下载工具](https://pan.baidu.com/s/1B8LptECX1Lcv8C9Qf5Y_eg?pwd=6666)，通过 bypassUAC_ComputerDefaults.exe

```cmd
bypassUAC_ComputerDefaults.exe "cmd.exe"
bypassUAC_ComputerDefaults.exe "c:\windows\system32\cmd.exe"
bypassUAC_ComputerDefaults.exe "c:\\windows\\system32\\cmd.exe"
```

![](https://pic1.imgdb.cn/item/68d0ee17c5157e1a88254a51.png)

查看权限，提权成功

![](https://pic1.imgdb.cn/item/68d0ef5cc5157e1a88255c8c.png)

**因为该方法需要动注册表 , 如果目标环境存在杀软, 基本上都会被拦截, 所以此方法只适用于无杀软的环 境 ,实战一般不采用**

![](https://pic1.imgdb.cn/item/68d0ef88c5157e1a88255e7c.png)

